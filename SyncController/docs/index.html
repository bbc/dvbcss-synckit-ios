<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SyncController  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>


    <a title="SyncController  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          SyncController Docs
        </a>
         (63% documented)
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/src/SyncController">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">SyncController Reference</a>
      <img class="carat" src="img/carat.png" />
      SyncController  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AudioSyncController.html">AudioSyncController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SyncControllerError.html">SyncControllerError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/VideoPlayerSyncController.html">VideoPlayerSyncController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WebViewProxy.html">WebViewProxy</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WebViewSyncController.html">WebViewSyncController</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerErrorDomain">SyncControllerErrorDomain</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerVersionNumber">SyncControllerVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerVersionString">SyncControllerVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kAudioSyncControllerResyncNotification">kAudioSyncControllerResyncNotification</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerMediaNotSeekable">kSyncControllerMediaNotSeekable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerNoSyncTimeline">kSyncControllerNoSyncTimeline</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerPlayerRateError">kSyncControllerPlayerRateError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerSyncTimelineUnavailable">kSyncControllerSyncTimelineUnavailable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kVideoSyncControllerResyncNotification">kVideoSyncControllerResyncNotification</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kWebSyncControllerResyncNotification">kWebSyncControllerResyncNotification</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/AudioSyncControllerState.html">AudioSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/VideoSyncControllerState.html">VideoSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/WebSyncControllerState.html">WebSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/kSyncControllerErrorTypes.html">kSyncControllerErrorTypes</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/InvocationProcessor.html">InvocationProcessor</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SyncControllerDelegate.html">SyncControllerDelegate</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <a href='#synccontroller-ios-framework-library' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='synccontroller-ios-framework-library'>SyncController iOS Framework Library</h1>

<ul>
<li><strong><a href="#how-to-use">How to use</a></strong></li>
<li><strong><a href="#read-the-documentation">Read the documentation</a></strong></li>
<li><strong><a href="#run-the-example-apps">Run the example apps</a></strong></li>
</ul>

<p>This library provides SyncController classes that can be used to synchronise a native media player to a given timeline.
Currently, a SyncController class is provided for each media player/web kit. Coalescing the various implementations into a single SyncController is in the works.</p>

<p>SyncController objects must be initialised with at least the following objects:
* a media player (<a href="">VideoPlayerViewController</a>, <a href="">AudioPlayer</a>, <a href="">AudioStreamPlayer</a> instances or in the case of a web view,  a UIWebView instance)
* a timeline to synchronise to (e.g. the Synchronisation Timeline - our local estimate of the TV&rsquo;s timeline)
* a correlation timestamp (a pair of timestamps) describing the relationship between the media timeline and the Synchronisation Timeline</p>
<a href='#dependencies' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='dependencies'>Dependencies</h3>

<p>The CIIProtocolClient library requires the following dynamic libraries (iOS frameworks) (found in SyncKit):</p>

<ol>
<li><a href="../../SyncKitConfiguration">SyncKitConfiguration</a></li>
<li><a href="../../SimpleLogger">SimpleLogger</a></li>
<li><a href="../../VideoPlayer">VideoPlayer</a> -</li>
<li><a href="../../AudioPLayer">AudioPlayerEngine</a> - the SocketRocket web socket library</li>
<li><a href="../../ClockTimelines">ClockTimelines</a></li>
</ol>
<a href='#read-the-documentation' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='read-the-documentation'>Read the documentation</h2>

<p>The docs for the library can be read <a href="SyncController/docs/index.html">here</a>.</p>
<a href='#how-to-use' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='how-to-use'>How to use</h2>

<p>A Cocoa Pod version of this library is not currently available. To use this library, follow these steps</p>
<a href='#add-the-framework-and-its-dependencies-to-your-project' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='add-the-framework-and-its-dependencies-to-your-project'>Add the framework and its dependencies to your project</h4>

<ol>
<li><em>Add the required projects to your workspace</em></li>
</ol>

<p>The easiest way to use the CIIProtocolClient framework is to include these Xcode projects to your XCode workspace.</p>

<ol>
<li><a href="../../SyncKitConfiguration">SyncKitConfiguration</a></li>
<li><a href="../../SimpleLogger">SimpleLogger</a></li>
<li><a href="../../VideoPlayer">VideoPlayer</a> -</li>
<li><a href="../../AudioPLayer">AudioPlayerEngine</a> - the SocketRocket web socket library</li>
<li><a href="../../ClockTimelines">ClockTimelines</a></li>
</ol>

<p>Then, after building these projects, go to your project&rsquo;s target window and <em>click on project in Project Navigator, then the project&rsquo;s target on right window in General tab</em>), add these frameworks in the <em>Linked Frameworks and libraries</em> section: <em>SyncKitConfiguration.framework, SimpleLogger.framework, VideoPlayer.framework, AudioPlayerEngine.framework, ClockTimelines.framework</em>.</p>

<ol>
<li><em>Add the dynamic libraries to your project</em></li>
</ol>

<p>Or alternatively, clone the SyncKit repository, open the main workspace and build all the projects to generate the dynamic libraries.</p>

<p>Then, in your project&rsquo;s target window (<em>click on project in Project Navigator, then the project&rsquo;s target on right window in General tab</em>), add the framework files in the <em>Linked Frameworks and libraries</em> section: <em>SyncKitConfiguration.framework, SimpleLogger.framework, VideoPlayer.framework, AudioPlayerEngine.framework, ClockTimelines.framework</em>.
  If you have two XCode instances running you can drag and drop the framework files from their respective project in SyncKit to your own project.
  Alternatively, you can include the dynamic libraries from their build locations</p>

<ol>
<li><em>Use the Cocoa Pod version</em></li>
</ol>

<p>Not available yet.</p>
<a href='#import-the-header-files' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='import-the-header-files'>Import the header files</h4>

<p>Once the library and its dependencies have been added to your project, import this header file in your source file:</p>
<pre class="highlight plaintext"><code>
#import &lt;SyncController/SyncController.h&gt;

</code></pre>
<a href='#create-and-configure-a-video-synccontroller-object' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='create-and-configure-a-video-synccontroller-object'>Create and configure a video SyncController object</h4>

<p>When a Synchronisation Timeline is available, a VideoPlayerSyncController can be initialised with a video player, the Synchronisation Timeline and a correlation timestamp and then started. The change in the <code>available</code> property is observed using Key-Value-Observer pattern.</p>

<p>A SyncController object uses a timer to trigger a resync operation (reevaluating the media player&rsquo;s current time w.r.t. the expected media time). The</p>

<p>The resync algorithm uses a simple strategy to catchup - if the asynchrony between the media player and the TV is more than <code>reSyncJitterThreshold</code> seconds, it requests the media player to seek to the new time position.
The default value is 0.02s for the <code>reSyncJitterThreshold</code> of a VideoPlayerSyncController object is <code>0,02s</code>.</p>

<p>More sophisticated resync strategies are described in the companion BBC WhitePaper: <em><q>How to synchronise to an HbbTV 2.0 compliant TV: A tutorial for companion app developers</q></em> available <a href="">here</a>.</p>
<pre class="highlight plaintext"><code>...
@property(nonatomic, readwrite) VideoPlayerSyncController * vSyncController;
...

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSString *,id&gt; *)change context:(void *)context
{
    if (context == WallClockContext) {
        if ([keyPath isEqualToString:kAvailableKey])
        {
            NSNumber *newAvailability = [change objectForKey:@"new"];

            NSLog(@"ViewController: WallClock is synchronised.");

            // only start timeline sync when wallclock is in sync
            if (([newAvailability boolValue] == YES) &amp;&amp; (_tvTimelineSyncer==nil)){
                NSLog(@"ViewController: synchronising timeline");
                [self startTimelineSync];
            }

        }
     }
    else if (context == TVTimelineContext) {

      if ([keyPath isEqualToString:kAvailableKey]) {

            BOOL oldTVTimelineAvailable = [[change objectForKey:@"old"]boolValue];
            BOOL newTVTimelineAvailable = [[change objectForKey:@"new"]boolValue];

            if (newTVTimelineAvailable){

                // start the video player
                [self startVideo];

                // setup a sync controller for video player
                Correlation corel = [CorrelationFactory create:0 Correlation:0];

                self.vSyncController = [VideoPlayerSyncController
                                        syncControllerWithVideoPlayer:self.videoPlayer
                                                        SyncTimeline:self.tvTimeline
                                                CorrelationTimestamp:&amp;corel
                                                        SyncInterval:4.0
                                                        AndDelegate:self];
                [self.vSyncController start];
            }
        }
    }
}

</code></pre>
<a href='#observe-the-synccontroller-status' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='observe-the-synccontroller-status'>Observe the SyncController status</h4>

<p>Each SyncController object can have a delegate that conforms  <a href="SyncController/SyncController/SyncControllerDelegate.h">SyncControllerDelegate</a> protocol. The delegate will then receive callbacks when the SyncController changes state. Possible SyncController states are:</p>
<pre class="highlight plaintext"><code>
typedef NS_ENUM(NSUInteger, VideoSyncControllerState)
{
    VideoSyncCrtlInitialised = 1,
    VideoSyncCrtlRunning,
    VideoSyncCrtlStopped,
    VideoSyncCrtlPaused,
    VideoSyncCrtlSynchronising,
    VideoSyncCrtlSyncTimelineUnavailable,
    VideoSyncCrtlSyncTimelineAvailable
};

</code></pre>

<p>Here is an example of a state change callback handler:</p>
<pre class="highlight plaintext"><code>
- (void) SyncController:(id) controller DidChangeState:(NSUInteger) state
{
    if (state == VideoSyncCrtlSyncTimelineAvailable) {

        if (![self.videoPlayer isPlaying])
        {
            [self.videoPlayer play];
        }
    }
}

</code></pre>
<a href='#run-the-example-apps' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='run-the-example-apps'>Run the example apps</h2>

<p>Three demo apps are included with this library:
* <a href="VideoSyncDemoApp/">VideoSyncDemoApp</a> - synchronising an HLS stream or a file-based video asset to a DVB-CSS TV
* <a href="AudioSyncDemoApp/">AudioSyncDemoApp</a> - synchronising an audio stream (mp3, aac, etc.) to a DVB-CSS TV
* <a href="WebViewSyncDemoApp">WebViewSyncDemoApp</a> - synchronising a web page animation to a DVB-CSS TV</p>

<p>To run these demo apps, you&rsquo;ll need the companion and TV assets. You can download them <a href="https://hbbtv-2-0-testing-1.virt.ch.bbc.co.uk/downloads/simple-free-sync-seq-1.zip">here</a>.</p>

<p>In each demo app project, you will need to specify the following constants:</p>
<pre class="highlight plaintext"><code>
NSString *serverAddress     = @"192.168.1.74";    // TV's IP address
NSString *contentId         = @"http://127.0.0.1:8123/channel_B_video.mp4";  // contentId of TV asset
NSString *timelineSelector  = @"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000";
NSString *tsEndpointURL     = @"ws://192.168.1.74:7681/ts";
int tick_rate = 5000;

</code></pre>

<p>To discover valid values for the <code>contentId</code>, <code>timelineSelector</code> and <code>tsEndpointURL</code>, you may use a CII client to connect to your TV.</p>
<pre class="highlight shell"><code><span class="gp">$ </span>python examples/CIIClient.py ws:/&lt;TV_IP_ADDRESS&gt;:7681/cii

</code></pre>

<p>What the received CII info may look like:</p>
<pre class="highlight shell"><code>
RD000400:pydvbcss rajivr<span class="nv">$ </span>python examples/CIIClient.py ws://10.5.11.163:7681/cii
INFO:CIIClient:connected
INFO:CIIClient:change to presentationStatus property. Value is now: <span class="o">[</span>u<span class="s1">'okay'</span><span class="o">]</span>
INFO:CIIClient:change to protocolVersion property. Value is now: 1.1
INFO:CIIClient:change to mrsUrl property. Value is now: None
INFO:CIIClient:change to timelines property. Value is now: <span class="o">[</span>TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>5000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)</span>, TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:1000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>1000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)]</span>
INFO:CIIClient:change to tsUrl property. Value is now: ws://10.5.11.163:7681/ts
INFO:CIIClient:change to wcUrl property. Value is now: udp://10.5.11.163:6677
INFO:CIIClient:change to contentIdStatus property. Value is now: final
INFO:CIIClient:change to contentId property. Value is now: http://127.0.0.1:8123/channel_B_video.mp4
INFO:CIIClient:CII is now: CII<span class="o">(</span><span class="nv">presentationStatus</span><span class="o">=[</span>u<span class="s1">'okay'</span><span class="o">]</span>, <span class="nv">protocolVersion</span><span class="o">=</span>u<span class="s1">'1.1'</span>, <span class="nv">mrsUrl</span><span class="o">=</span>None, <span class="nv">timelines</span><span class="o">=[</span>TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>5000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)</span>, TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:1000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>1000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)]</span>, <span class="nv">tsUrl</span><span class="o">=</span>u<span class="s1">'ws://10.5.11.163:7681/ts'</span>, <span class="nv">wcUrl</span><span class="o">=</span>u<span class="s1">'udp://10.5.11.163:6677'</span>, <span class="nv">contentIdStatus</span><span class="o">=</span>u<span class="s1">'final'</span>, <span class="nv">contentId</span><span class="o">=</span>u<span class="s1">'http://127.0.0.1:8123/channel_B_video.mp4'</span><span class="o">)</span>

</code></pre>

<ul>
<li>The contentId in this example is <strong><q>http://127.0.0.1:8123/channel_B_video.mp4</q></strong></li>
<li>The timelineSelector is <strong><q>tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000</q></strong>,</li>
<li>The timeline synchronisation server (tsURL) is <strong>ws://10.5.11.163:7681/ts</strong></li>
</ul>
<a href='#licence' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='licence'>Licence</h2>

<p>The SyncController iOS Framework is developed by BBC R&amp;D and distributed under Licensed under the Apache License, <a href="http://www.apache.org/licenses/LICENSE-2.0">Version 2.0</a>.</p>

<p>© Copyright 2016 BBC R&amp;D. All Rights Reserved</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2016 <a class="link" href="http://bbc.co.uk/rd" target="_blank" rel="external">Rajiv_Ramdhany</a>. All rights reserved. (Last updated: 2016-10-03)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
