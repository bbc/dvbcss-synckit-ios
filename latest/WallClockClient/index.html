<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WallClockClient  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    <div style="margin:0; width: 100%; padding: 8px 0 0 8px;" class="header">
    <a href="../index.html" style="margin: 0; padding: 0 8px; font-weight: bold; color:white;">
        dvbcss-synckit-ios
    </a>
</div>

  </head>
  <body>


    <a title="WallClockClient  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          WallClockClient Docs
        </a>
        
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/bbc/dvbcss-synckit-ios">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">WallClockClient Reference</a>
      <img class="carat" src="img/carat.png" />
      WallClockClient  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Candidate.html">Candidate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CandidateSink.html">CandidateSink</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/LowestDispersionAlgorithm.html">LowestDispersionAlgorithm</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/LowestDispersionFilter.html">LowestDispersionFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RTTThresholdFilter.html">RTTThresholdFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WCProtocolClient.html">WCProtocolClient</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WCSyncMessage.html">WCSyncMessage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WallClockSynchroniser.html">WallClockSynchroniser</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@WallClockClientVersionNumber">WallClockClientVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@WallClockClientVersionString">WallClockClientVersionString</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/ICandidateHandler.html">ICandidateHandler</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IFilter.html">IFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IWCAlgo.html">IWCAlgo</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Type Definitions.html">Type Definitions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions/WCSyncMessagePkt.html">WCSyncMessagePkt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions/WCTimeValue.html">WCTimeValue</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <a href='#small-dvbcss-synckit-ios-small-br-wallclockclient-framework' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='small-dvbcss-synckit-ios-small-br-wallclockclient-framework'><small>dvbcss-synckit-ios</small><br/>WallClockClient Framework</h1>

<ul>
<li><strong><a href="#how-to-use">How to use</a></strong></li>
<li><strong><a href="#read-the-documentation">Read the documentation</a></strong></li>
<li><strong><a href="#run-the-example-app">Run the example app</a></strong></li>
</ul>

<p>A Wall Clock time synchronisation component that uses the DVB-CSS WallClock synchronisation (CSS-WC) protocol. It is used by Companion Screen applications to synchronise their Wall Clock with a DVB-CSS/HbbTV2.0 TV/STB.</p>

<p>The <strong>WallClockClient</strong> iOS framework library includes a number of components that when connected together will exchange messages with a CSS-WC protocol server, process the messages and generate measurements for the offset between the Companion Screen application&rsquo;s local WallClock and a TV and the initial dispersion value for that measurement. These candidate measurements (called Candidates) are then filtered and submitted to an algorithm for processing.</p>

<p>The Candidate measurement filter is used to drop candidates that are unlikely to provide a good estimate of the TV&rsquo;s WallClock time. For example, measurements  collected with large round-trip times (RTT) can be discarded by an RTTThreshold filter.</p>

<p>The candidate-processing algorithm determines if a new candidate measurement offers a better estimate of the TV&rsquo;s Wall Clock time than a previously-seen candidate measurement. For example, the <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/LowestDispersionAlgorithm.h">LowestDispersion</a> algorithm is used to ensure that only the candidate measurement with the current lowest dispersion value is selected as the currently-known best estimate of the TV WallClock time.</p>

<p>To perform WallClock time synchronisation using this library, the following classes are used:</p>

<ol>
<li><p><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/WallClockSynchroniser.h">WallClockSynchroniser</a> - A <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/WallClockSynchroniser.h">WallClockSynchroniser</a> instance initialised with a CSS-WC server&rsquo;s host address and port number.
This is a configurator object to assemble the various objects together and start/stop the WallClock sync.</p></li>
<li><p><a href="https://github.com/bbc/dvbcss-synckit-ios/blob/master/src/ClockTimelines/ClockTimelines/TunableClock.h">TunableClock</a> -  A local WallClock that will be updated by the offset, initial error and error growth rate. In this implementation, the same WallClock in used to timestamp WC protocol
messages.</p></li>
<li><p><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/WCProtocolClient.h">WCProtocolClient</a> - A CSS-WC protocol client to send CSS-WC requests and receive CSS-WC responses.
On reception of WC response messages, the WCProtocolClient object creates a Candidate
 measurement object and submits it to a CandidateSink object for further proccesing.</p></li>
<li><p><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/CandidateSink.h">CandidateSink</a> - A Candidate measurement handler object to send each new candidate through a chain of filters. If the candidate survives the filtration process, the CandidateSink object serves it to an algorithm for processing.</p></li>
<li><p><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/LowestDispersionAlgorithm.h">LowestDispersionAlgorithm</a> - An algorithm object to process Candidates and readjust the local WallClock&rsquo;s offset. WC
algorithms must conform to the IWCAlgo protocol. Other algorithms such as lowest RTT can be plugged in as long as they implement the IWCAlgo interface.</p></li>
<li><p>A list of filters e.g. <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/RTTThresholdFilter.h">RTTThresholdFilter</a> (IFilter protocol-conforming objects) to reject unsuitable Candidates e.g. a candidates with an RTT that exceeds a specified threshold.</p></li>
</ol>
<a href='#dependencies' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='dependencies'>Dependencies</h3>

<p>The WallClockClient library requires the following dynamic libraries (iOS frameworks) (found in SyncKit):</p>

<ol>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SyncKitCollections">SyncKitCollections</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SimpleLogger">SimpleLogger</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../UDPMessaging">UDPMessaging</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../ClockTimelines">ClockTimelines</a></li>
</ol>
<a href='#read-the-documentation' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='read-the-documentation'>Read the documentation</h2>

<p>The docs for the library can be read <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/docs/index.html">here</a>.</p>
<a href='#how-to-use' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='how-to-use'>How to use</h2>

<p>A Cocoa Pod version of this library is not currently available. To use this library,</p>
<a href='#add-the-framework-and-its-dependencies-to-your-project' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='add-the-framework-and-its-dependencies-to-your-project'>Add the framework and its dependencies to your project</h4>

<ol>
<li><em>Add the required projects to your workspace</em></li>
</ol>

<p>The easiest way to use the WallClockClient framework is to include these Xcode projects to your XCode workspace.
  * WallClockClient
  * SyncKitCollections
  * SimpleLogger
  * UDPMessaging
  * ClockTimelines</p>

<p>Then, after building these projects, go to your project&rsquo;s target window and <em>click on project in Project Navigator, then the project&rsquo;s target on right window in General tab</em>), add these frameworks in the <em>Linked Frameworks and libraries</em> section: <em>WallClockClient.framework, SyncKitCollections.framework, SimpleLogger.framework, UDPMessaging.framework, ClockTimelines.framework</em>.</p>

<ol>
<li><em>Add the dynamic libraries to your project</em></li>
</ol>

<p>Or alternatively, clone the SyncKit repository, open the main workspace and build all the projects.</p>

<p>Then, in your project&rsquo;s target window (<em>click on project in Project Navigator, then the project&rsquo;s target on right window in General tab</em>), add the framework files in the <em>Linked Frameworks and libraries</em> section: <em>DIALDeviceDiscovery.framework, SyncKitConfiguration.framework, SyncKitCollections.framework, SimpleLogger.framework, AsyncSocket.framework</em>.
  If you have two XCode instances running you can drag and drop the framework files from their respective project in SyncKit to your own project.</p>

<ol>
<li><em>Use the Cocoa Pod version</em></li>
</ol>

<p>Not available yet.</p>
<a href='#import-the-header-files' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='import-the-header-files'>Import the header files</h4>

<p>Once the library and its dependencies have been added to your project, import this header file in your source file:</p>
<pre class="highlight plaintext"><code>
  #import &lt;WallClockClient/WallClockClient.h&gt;
  #import &lt;ClockTimelines/ClockTimelines.h&gt;

</code></pre>
<a href='#create-and-configure-a-wallclock-synchroniser-object' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='create-and-configure-a-wallclock-synchroniser-object'>Create and configure a WallClock synchroniser object</h4>

<p>Create a WallClock, candidate-processing algorithm and filter list and use this to initialise a WallClockSynchroniser instance:</p>
<pre class="highlight plaintext"><code>
  SystemClock             *sysCLK;            // a system clock based on this device monotonic time
  TunableClock            *wallclock;         // a WallClock whose time will be synchronised using the WC protocol
  id&lt;IWCAlgo&gt;             algorithm;          // an algorithm for processing candidate measurements
  id&lt;IFilter&gt;             filter;             // a filter to reject unsuitable candidate measurements
  NSMutableArray          *filterList;        // a filter list
  WallClockSynchroniser   *wallclock_syncer;  // a component that drives our time synchronisation


  sysCLK = [[SystemClock alloc] initWithTickRate:_kOneThousandMillion];

  //create a tunable clock with start ticks equal to system clock current ticks and same tick rate as the system clock.
  wallclock = [[TunableClock alloc] initWithParentClock:sysCLK TickRate:_kOneThousandMillion Ticks:0];

  algorithm = [[LowestDispersionAlgorithm alloc] initWithWallClock:wallclock];
  filter = [[RTTThresholdFilter alloc] initWithThreshold:1000];
  filterList = [NSMutableArray arrayWithObject:filter];

  wallclock_syncer = [[WallClockSynchroniser alloc] initWithWCServer:serverAddress
                                                                Port:6677 WallClock:wallclock
                                                           Algorithm:algorithm
                                                          FilterList:filterList];

</code></pre>
<a href='#register-for-notifications-of-when-the-wallclock-becomes-code-available-code-i-e-in-a-synchronised-state' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='register-for-notifications-of-when-the-wallclock-becomes-code-available-code-i-e-in-a-synchronised-state'>Register for notifications of when the WallClock becomes <code>available</code> i.e. in a synchronised state</h4>
<pre class="highlight plaintext"><code>
  [_wallclock addObserver:self forKeyPath:kAvailableKey options:NSKeyValueObservingOptionOld | NSKeyValueObservingOptionNew context:WallClockContext];


</code></pre>
<a href='#start-the-wallclock-synchroniser' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='start-the-wallclock-synchroniser'>Start the WallClock synchroniser</h4>
<pre class="highlight plaintext"><code>// --- start WallClock Sync ----
[wallclock_syncer start];


</code></pre>
<a href='#run-the-example-app' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='run-the-example-app'>Run the example app</h2>

<p>A demo app called <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockCientDemoApp/">WallClockCientDemoApp</a> is included with the library. To run the demo,open the WallClockSync workspace (<em>WallClockSync.xcworkspace</em> file) in XCode. Choose the WallClockCientDemoApp target, build it and deploy the app on your iOS device.</p>

<p>On the server side, if you need an example implementation of a CSS-WC server, then clone the following library:
[<a href="https://github.com/bbc/pydvbcss">https://github.com/bbc/pydvbcss</a>]. The <code>examples</code> folder has a server implementation: <code>WallClockServer.py</code></p>

<p>Run this WallClock Synchronisation server specifying a network interface address and a port number as illustrated below:</p>
<pre class="highlight plaintext"><code>$ python examples/WallClockServer.py 192.168.0.2 6677
</code></pre>
<a href='#licence' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='licence'>Licence</h2>

<p>The WallClockClient Framework is developed by BBC R&amp;D and distributed under Licensed under the Apache License, <a href="http://www.apache.org/licenses/LICENSE-2.0">Version 2.0</a>.</p>

<p>© Copyright 2016 BBC R&amp;D. All Rights Reserved</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; British Broadcasting Corporation, under <a class="link" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="external">Apache 2.0 open source licence</a></p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
